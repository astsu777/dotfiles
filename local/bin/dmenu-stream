#!/usr/bin/env sh
#=========================================================================
# Author: Gaetan (gaetan@ictpourtous.com) - Twitter: @GaetanICT
# Creation: Sun 22 Aug 2021 12:12:43
# Last modified: Mon 27 Sep 2021 15:13:18
# Version: 1.0
#
# Description: check online streams and watch them
#=========================================================================

# Requirements check
if ! type youtube-dl mpv > /dev/null 2>&1; then
	notify-send "⚠️ Error" "Please install 'mpv' and 'youtube-dl' to use this script"
	exit 1
fi

# Define streams list
Streams="$HOME/.local/share/streams"
if [ ! -f "$Streams" ]; then
	notify-send "⚠️ Error" "Stream list does not exist!"
	exit 2
fi

# Check for on-going instance
if lsof "$Streams" > /dev/null 2>&1; then
	notify-send "Script already running" "Checking for online streams. Please wait..."
	exit 4
fi

# Check online streams
Cache="$XDG_CACHE_HOME/onlinestreams"
if [ -f "$Cache" ] && test "$(find "$Cache" -mmin +10)" || [ ! -f "$Cache" ]; then
	OPTS=$(printf "Refresh Online Streams\nUse Cache" | sort | dmenu -i -p "Cache is older than 10 minutes. Choose:")
	case "$OPTS" in
		'Refresh Online Streams')
			rm "$Cache"
			OnlineStreams=$(mktemp)
			notify-send "🎬 Checking online streams" "Please wait, it may take a while..."
			while IFS="" read -r i; do
				youtube-dl -F "$i" > /dev/null 2>&1 && echo "$i" >> "$OnlineStreams"
			done < "$Streams"
			mv "$OnlineStreams" "$Cache" > /dev/null 2>&1
			notify-send "🎬 Refreshed online streams" "The online streams cache has been generated" && setsid -f paplay "$(find "${XDG_CONFIG_HOME:-~/.config}"/dunst/*.wav | shuf -n 1)"
			;;
		'Use Cache')
			;;
		*)
			exit 0 ;;
	esac
fi

# Choose a stream to watch
Stream=$(sort "$Cache" | dmenu -i -l 30 -p "Online streams:")

# Watch the stream
if [ -z "$Stream" ]; then exit 3; fi
if type dmenu-video > /dev/null 2>&1; then dmenu-video "$Stream"; else nohup mpv --cache=yes --really-quiet "$Stream" > /dev/null 2>&1 ; fi
exit 0
