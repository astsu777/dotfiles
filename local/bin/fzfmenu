#!/usr/bin/env sh
#=========================================================================
# Author: Gaetan (gaetan@ictpourtous.com) - Twitter: @GaetanICT
# Creation: Fri 27 Aug 2021 21:25:24
# Last modified: Fri 27 Aug 2021 21:25:59
# Version: 1.0
#
# Description: use FZF as a DMenu replacement
# Example: proc=$(compgen -c | sort -u | fzfmenu) && "$proc" --> dmenu_run
#=========================================================================

# fifos are here to not wait for end of input
# (useful for e.g. find $HOME | fzfmenu ...)
input=$(mktemp -u --suffix .fzfmenu.input)
output=$(mktemp -u --suffix .fzfmenu.output)
mkfifo "$input"
mkfifo "$output"
chmod 600 "$input" "$output"

# it's better to use st here (starts a lot faster than pretty much everything else)
# the ugly printf | sed thing is here to make args with quotes work.
# (e.g. --preview='echo {1}').
# sadly we can't use "$@" here directly because we are inside sh -c "..." call
# already.
# you can also set window dimensions via -g '=COLSxROWS', see man st.
st -c fzfmenu -n fzfmenu -e bash -c "cat $input | fzf $(printf -- " '%s'" "$@" | sed "s/^ ''$//") | tee $output" &

# handle ctrl+c outside child terminal window
trap 'kill "$!" 2>/dev/null; rm -f "$input" "$output"' EXIT

cat > "$input"
cat "$output"